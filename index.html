<!DOCTYPE html>
<html>
<head>
  <title>Secure HD Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    #remoteVideo, #localVideo {
      position: absolute;
      background: #000;
      object-fit: cover;
    }
    #remoteVideo {
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }
    #localVideo {
      bottom: 85px;
      right: 10px;
      width: 110px;
      height: 150px;
      border-radius: 10px;
      border: 1px solid #ccc;
      transform: scaleX(-1);
      z-index: 5;
      cursor: pointer;
    }
    .local-fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      top: 0 !important;
      left: 0 !important;
      bottom: auto !important;
      right: auto !important;
      z-index: 4 !important;
    }
    .remote-small {
      width: 110px !important;
      height: 150px !important;
      bottom: 85px !important;
      left: 10px !important;
      z-index: 3 !important;
    }
    .top-bar {
      position: absolute;
      top: 10px; left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 10px 16px;
      border-radius: 24px;
      align-items: center;
    }
    .id-tap {
      color: white;
      font-size: 16px;
      cursor: pointer;
      max-width: 150px;
      overflow: hidden;
      white-space: nowrap;
    }
    #peerIdInput {
      padding: 7px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      width: 140px;
    }
    #joinBtn {
      padding: 7px 14px;
      font-size: 14px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #controls {
      position: absolute;
      bottom: 12px; left: 50%;
      transform: translateX(-50%);
      display: flex;
      background: rgba(20,20,20,0.9);
      padding: 8px 16px;
      border-radius: 32px;
      gap: 12px;
      z-index: 10;
    }
    .ctrl-btn {
      width: 50px; height: 50px;
      border-radius: 50%;
      border: none;
      background-color: #444;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .ctrl-btn img {
      width: 26px; height: 26px;
      filter: invert(100%);
    }
    .ctrl-btn.toggled-off {
      background-color: white;
    }
    .ctrl-btn.toggled-off img {
      filter: invert(0%);
    }
    .end-call {
      background-color: crimson !important;
    }
    #captureBtn {
      position: absolute;
      top: 80px;
      right: 10px;
      z-index: 10;
      padding: 10px 16px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>

  <div class="top-bar" id="topBar">
    <div class="id-tap" onclick="copyId()">ID: <span id="peerIdText">Loading...</span></div>
    <input type="text" id="peerIdInput" placeholder="Enter Host ID" />
    <button id="joinBtn" onclick="startCall()">Join</button>
  </div>

  <div id="controls">
    <button class="ctrl-btn" id="videoBtn" onclick="toggleVideo()">
      <img src="https://cdn-icons-png.flaticon.com/512/5948/5948966.png" />
    </button>
    <button class="ctrl-btn" id="audioBtn" onclick="toggleAudio()">
      <img src="https://cdn-icons-png.flaticon.com/512/5561/5561764.png" />
    </button>
    <button class="ctrl-btn end-call" onclick="endCall()">
      <img src="https://cdn-icons-png.flaticon.com/512/733/733497.png" />
    </button>
  </div>

  <button id="captureBtn">ðŸ“¸ Take Photo</button>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let localStream;
    let currentCall;
    const peer = new Peer();
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    peer.on("open", (id) => {
      document.getElementById("peerIdText").textContent = id;
    });

    peer.on("call", async (call) => {
      currentCall = call;
      if (!localStream) await getMedia();
      call.answer(localStream);
      call.on("stream", (remoteStream) => {
        remoteVideo.srcObject = remoteStream;
        document.getElementById("topBar").style.display = "none";
      });
    });

    async function getMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            frameRate: { ideal: 30, max: 60 }
          },
          audio: true
        });
        localVideo.srcObject = localStream;
      } catch (err) {
        alert("Camera or Mic not accessible.");
        console.error(err);
      }
    }

    async function startCall() {
      const peerId = document.getElementById("peerIdInput").value.trim();
      if (!peerId) return alert("Enter a valid Peer ID.");
      if (!localStream) await getMedia();

      const call = peer.call(peerId, localStream);
      currentCall = call;

      call.on("stream", (remoteStream) => {
        remoteVideo.srcObject = remoteStream;
        document.getElementById("topBar").style.display = "none";
      });
    }

    function toggleVideo() {
      const track = localStream.getVideoTracks()[0];
      track.enabled = !track.enabled;
      document.getElementById("videoBtn").classList.toggle("toggled-off", !track.enabled);
    }

    function toggleAudio() {
      const track = localStream.getAudioTracks()[0];
      track.enabled = !track.enabled;
      document.getElementById("audioBtn").classList.toggle("toggled-off", !track.enabled);
    }

    function endCall() {
      if (currentCall) {
        currentCall.close();
        remoteVideo.srcObject = null;
        document.getElementById("topBar").style.display = "flex";
      }
    }

    function copyId() {
      const id = document.getElementById("peerIdText").textContent;
      navigator.clipboard.writeText(id);
      alert("Copied ID: " + id);
    }

    // Swap local & remote video positions
    let isLocalBig = false;
    function swapVideos() {
      isLocalBig = !isLocalBig;
      localVideo.classList.toggle("local-fullscreen", isLocalBig);
      remoteVideo.classList.toggle("remote-small", isLocalBig);
    }
    localVideo.onclick = swapVideos;
    remoteVideo.onclick = swapVideos;

    // ðŸ“¸ Capture remote video in HD
    document.getElementById("captureBtn").addEventListener("click", () => {
      if (!remoteVideo.srcObject) return alert("No remote video available!");

      const canvas = document.createElement("canvas");
      canvas.width = remoteVideo.videoWidth;
      canvas.height = remoteVideo.videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(remoteVideo, 0, 0, canvas.width, canvas.height);

      canvas.toBlob((blob) => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "snapshot_hd.png";
        link.click();
      }, "image/png");
    });

    getMedia();
  </script>
</body>
</html>
